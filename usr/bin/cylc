#!/bin/bash

# THIS FILE IS PART OF THE CYLC SUITE ENGINE.
# Copyright (C) NIWA & British Crown (Met Office) & Contributors.
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# PURPOSE:
# Central wrapper to select between multiple installed Cylc versions
# Original author (pre Cylc 8): Matt Shin

# INSTALLATION: 
# Install this script as "cylc" in $PATH for normal users
# **Cylc 8**
#  - Install Cylc into pip or conda virtual environments
# **Cylc 7** back compat:
#  - Install manually side-by-side, e.g. to /opt/cylc-7.x.y
#  - use $CYLC_VERSION, $CYLC_HOME_ROOT, $CYLC_HOME as below

if [[ -n "${VIRTUAL_ENV}" ]]; then
    # Cylc 8 Python virtual env
    echo exec "${VIRTUAL_ENV}/bin/cylc" "$@"

elif [[ -n "${CONDA_DEFAULT_ENV}" ]]; then
    # Cylc 8 Conda env
    echo exec conda run -n "${CONDA_DEFAULT_ENV}" cylc "$@"

else
    # CYLC 7 Backward compatibility
    #   - set CYLC_HOME_ROOT below to site install dir e.g. /opt
    #   - developers can use $CYLC_HOME to override the root dir
    #   - users and jobs set $CYLC_VERSION to get a specific version
    CYLC_HOME_ROOT="${CYLC_HOME_ROOT:-/opt}" # !!! EDIT ME !!!
    if [[ -z "${CYLC_HOME:-}" ]]; then
        if [[ -n "${CYLC_VERSION:-}" && \
                -d "${CYLC_HOME_ROOT}/cylc-${CYLC_VERSION}" ]]; then
            CYLC_HOME="${CYLC_HOME_ROOT}/cylc-${CYLC_VERSION}"
        else
            CYLC_HOME="${CYLC_HOME_ROOT}/cylc"
        fi
    fi
    echo exec "${CYLC_HOME}/bin/cylc" "$@"
fi
