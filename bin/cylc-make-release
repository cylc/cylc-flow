#!/bin/bash

set -e; trap "echo ERROR" ERR

function usage {
cat <<eof
USAGE: cylc [admin] make-release [OPTIONS] [ARGUMENTS]

Generate a cylc release tarball from the head of a repository branch
(default: current branch). This command must run in the top of a cylc
repository clone; it will fail if run from an existing release version.

The "release number" is automatically generated by 'git describe' which
references (a) the latest annotated tag, (b) the number of commits since
the tag, and (c)the hash ID of the latest commit. If the latest tag
points to the latest commit only (a) will be used, e.g. 5.1.0. 

How to apply an annotated tag to the repository:
 % git tag -a x.y.z -m 'Official cylc-x.y.z release.'

To generate the Cylc User Guide you must have LaTeX installed (for
'pdflatex') and TEX4ht (for 'htlatex'); else use [-n] or [-m] options.

Options:
   -x            - DO NOT run automated cylc tests before proceeding.
   -n            - DO NOT generate the Cylc User Guide at all.
   -m            - DO NOT generate an HTML Cylc User Guide.

Arguments:
   [BRANCH-NAME] - Branch name (optional, defaults to current branch)
eof
}

for ARG in $@; do
    if [[ $ARG == '--help' || $ARG == "help" ]]; then
        usage
        exit 0
    fi
done

RUN_TESTS=true
RUN_LATEX=true
RUN_HTML=true
while getopts xnmh OPT; do
    case "$OPT" in
        h)
        usage
        exit 0
        ;;
        x)
        RUN_TESTS=false
        ;;
        n)
        RUN_LATEX=false
        ;;
        m)
        RUN_HTML=false
        ;;
    esac
done

shift $(( OPTIND-1 ))

unset BRANCH
if [[ $# == 1 ]]; then
    BRANCH=$1
elif [[ $# > 1 ]]; then
    usage
    exit 1
fi

VERSION=$( git describe )
RELEASE=cylc-$VERSION
TARBALL=${RELEASE}.tgz
BRANCH=${BRANCH:-$( git rev-parse --abbrev-ref HEAD )}
LOG=$( mktemp )

echo "GENERATING $RELEASE FROM $BRANCH"

echo " + extracting source"
mkdir -p $RELEASE
git archive $BRANCH | tar -x -C $RELEASE
cd $RELEASE

echo " + running tests (to watch: \"tail -F $LOG\")"
if $RUN_TESTS; then
    echo "   - checking all example suites validate ..."
    cylc admin check-examples > $LOG 2>&1
    # run tests
    echo "   - registration db checks ..."
    cylc admin test-db >> $LOG 2>&1
    echo "   - suite test battery ..."
    cylc admin test-battery >> $LOG 2>&1
fi

echo " + setting version tag"
perl -pi -e "s/VERSION-TEMPLATE/$VERSION/" lib/cylc/version.py
perl -pi -e "s/VERSION-TEMPLATE/$VERSION/" README

if $RUN_LATEX; then
    echo " + generating User Guide (to watch: \"tail -F $LOG\")"
    if $RUN_HTML; then 
        doc/process >> $LOG 2>&1
    else
        echo "   - (WARNING: PDF only, HTML disabled)"
        doc/process -p >> $LOG 2>&1
    fi
    echo " + deleting documentation source"
    # copy and restore generated documents from doc.
    mkdir tmpdoc
    cp doc/cug-pdf.pdf tmpdoc
    cp doc/*.html tmpdoc
    cp doc/*.css tmpdoc
    cp -r doc/images tmpdoc
    cp -r doc/screenshots tmpdoc
    cp -r doc/single/ tmpdoc
    rm -r doc
    mv tmpdoc doc
    mv doc/cug-pdf.pdf doc/CylcUserGuide.pdf
else
    echo " + WARNING: User Guide processing disabled"
    rm -rf doc
    mkdir doc
    cat > doc/README <<eof
The Cylc User Guide was not generated for this local release; please see
your cylc administrator for advice.
eof
fi

echo " + deleting dev directory"
rm -r dev

echo " + removing .pyc files"
find . -name '*.pyc' | xargs rm -f

cd .. 
echo " + creating tarball $TARBALL"
tar czf $TARBALL $RELEASE

echo "DONE"

